<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistant Chatbot</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        display: flex;
        flex-direction: column;
    }
    .chat-box {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        width: 50%;
        margin: auto;
        margin-top: 20px;
        border: 1px solid #ccc;
        border-radius: 10px;
        background-color: white;
        overflow: hidden;
    }
    .chat-container {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
    }
    .message {
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 75%;
        margin: 10px 0;
        word-wrap: break-word;
        position: relative;
    }
    .message .speak-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }
    .user-message {
        background-color: #395AC7;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .assistant-message {
        background-color: #EAEAEA;
        color: black;
        text-align: left;
    }
    .input-box {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background-color: #fff;
    }
    .input-box input {
        flex-grow: 1;
        padding: 10px 15px;
        border-radius: 20px;
        border: 1px solid #ccc;
        font-size: 16px;
        outline: none;
    }
    .input-box button {
        margin-left: 10px;
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        background-color: #395AC7;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }
    .input-box #voice-btn {
        margin-left: 5px;
        padding: 10px;
        border-radius: 50%;
        border: none;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }
    .command-buttons {
        display: flex;
        justify-content: center;
        margin: 10px 0;
        gap: 10px;
        flex-wrap: wrap;
    }
    .command-buttons button {
        padding: 8px 15px;
        border-radius: 15px;
        border: none;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        flex: 1 1 45%;
        max-width: 150px;
    }
    @media (max-width: 600px) {
        .command-buttons button {
            flex: 1 1 48%;
        }
    }
</style>
</head>
<body>
<div class="chat-box">
    <div class="chat-container" id="chat-container"></div>

    <form class="input-box" id="chat-form">
        <input type="text" id="user_input" placeholder="Type your message..." required>
        <button type="submit">Send</button>
        <button id="voice-btn" type="button">ðŸŽ¤</button>
    </form>

    <div class="command-buttons">
        <button id="restart-btn">Restart</button>
        <button id="clear-btn">Clear</button>
        <button id="show-history-btn">Show History</button>
    </div>
</div>

<script>
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user_input');
const chatContainer = document.getElementById('chat-container');
const voiceBtn = document.getElementById('voice-btn');
const restartBtn = document.getElementById('restart-btn');
const clearBtn = document.getElementById('clear-btn');
const showHistoryBtn = document.getElementById('show-history-btn');

// Generate or retrieve a session ID from backend
let sessionId = localStorage.getItem('sessionId');

async function fetchSessionId() {
    try {
        const response = await fetch('https://my-chatbot-func00.azurewebsites.net/api/online-chat', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
            const data = await response.json();
            if (data.session_id) {
                sessionId = data.session_id;
                localStorage.setItem('sessionId', sessionId);
            }
        } else {
            console.error('Failed to fetch session ID from backend');
        }
    } catch (error) {
        console.error('Error fetching session ID:', error);
    }
}

if (!sessionId) {
    fetchSessionId();
}

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Speech recognition
let recognition;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    voiceBtn.addEventListener('click', () => {
        recognition.start();
        voiceBtn.textContent = 'ðŸŽ™ï¸';
    });

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        voiceBtn.textContent = 'ðŸŽ¤';
        chatForm.dispatchEvent(new Event('submit'));
    };

    recognition.onerror = () => {
        voiceBtn.textContent = 'ðŸŽ¤';
        addMessage('Speech recognition error', false);
    };

    recognition.onend = () => {
        voiceBtn.textContent = 'ðŸŽ¤';
    };
} else {
    voiceBtn.style.display = 'none';
}

function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(isUser ? 'user-message' : 'assistant-message');
    messageDiv.textContent = text;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addTypingEffect(text) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'assistant-message');
    chatContainer.appendChild(messageDiv);

    let index = 0;
    function typeChar() {
        messageDiv.textContent = text.slice(0, index + 1);
        index++;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        if (index < text.length) {
            setTimeout(typeChar, 20);
        } else {
            const speakBtn = document.createElement('button');
            speakBtn.classList.add('speak-btn');
            speakBtn.textContent = 'ðŸ”Š';
            speakBtn.onclick = () => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                }
            };
            messageDiv.appendChild(speakBtn);
        }
    }
    typeChar();
}

async function sendMessage(message) {
    if (!message.trim()) return;
    if (!sessionId) sessionId = generateUUID();

    addMessage(message, true);
    userInput.value = '';

    try {
        const response = await fetch('https://my-chatbot-func00.azurewebsites.net/api/online-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_input: message, session_id: sessionId })
        });
        console.log('Response status:', response.status);

        if (!response.ok) {
            addMessage('Error: ' + response.statusText, false);
            return;
        }

        const data = await response.json();
        if (data.response) addTypingEffect(data.response);
        else addMessage('Error: Invalid response from server', false);
    } catch (err) {
        addMessage('Error: Could not reach server', false);
    }
}

function sendCommand(cmd) {
    sendMessage(cmd);
}

// Form submission
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (message) sendMessage(message);
});

// Enter key shortcut
userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') chatForm.dispatchEvent(new Event('submit'));
});

// Command buttons
restartBtn.addEventListener('click', () => sendCommand('restart'));
clearBtn.addEventListener('click', () => sendCommand('clear'));
showHistoryBtn.addEventListener('click', () => sendCommand('show history'));

// Welcome message
window.addEventListener('load', () => {
    addTypingEffect("Hello! I am your AI assistant. Ask me anything related to AI.");
});
</script>
</body>
</html>
